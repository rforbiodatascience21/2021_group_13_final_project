---
title: "Presentation"
author: "s210136, s200177, s202754"
date: "5/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Define functions ------------------------------------------------------------

```{r}
source(file = "R/99_project_functions.R")
```

```{r libraries, include=FALSE}
library(tidyverse)
library(tidyseurat)
```

# Loading data of all patients ------------------------------------------------

```{r patient_load}
patient_1 <- read_rds(file = "Data/_raw/GSM4058963_025I.dgecounts.rds")
```
Get gene identifiers from first patient

```{r gene_extract}
Genes <- patient_1 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>%   
  pluck("Dimnames") %>% 
  pluck(1) %>% 
  as_tibble()

write_csv(Genes,
          file = "Data/Genes_1")
rm(Genes)
```

We downsample in load as we cannot work with such big data on PCs
```{r downsample}
patient_1 <- patient_1 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>% 
  as_tibble() %>% 
  select(c(1:2000))
```

Repeat operations for 5 remaining subjects (not shown)
```{r, echo=FALSE}
patient_2 <- read_rds(file = "Data/_raw/GSM4058907_465C.dgecounts.rds")

Genes <- patient_2 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>%   
  pluck("Dimnames") %>% 
  pluck(1) %>% 
  as_tibble()

write_csv(Genes,
          file = "Data/Genes_2")
rm(Genes)

patient_2 <- patient_2 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>% 
  as_tibble() %>% 
  select(c(1:2000))

patient_3 <- read_rds(file = "Data/_raw/GSM4058921_003C.dgecounts.rds")

Genes <- patient_3 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>%   
  pluck("Dimnames") %>% 
  pluck(1) %>% 
  as_tibble()

write_csv(Genes,
          file = "Data/Genes_3")
rm(Genes)

patient_3 <- patient_3 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>% 
  as_tibble() %>% 
  select(c(1:2000))

patient_4 <- read_rds(file = "Data/_raw/GSM4058936_207CO.dgecounts.rds")

Genes <- patient_4 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>%   
  pluck("Dimnames") %>% 
  pluck(1) %>% 
  as_tibble()

write_csv(Genes,
          file = "Data/Genes_4")
rm(Genes)

patient_4 <- patient_4 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>% 
  as_tibble() %>% 
  select(c(1:2000))

patient_5 <- read_rds(file = "Data/_raw/GSM4058944_056CO.dgecounts.rds")

Genes <- patient_5 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>%   
  pluck("Dimnames") %>% 
  pluck(1) %>% 
  as_tibble()

write_csv(Genes,
          file = "Data/Genes_5")
rm(Genes)

patient_5 <- patient_5 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>% 
  as_tibble() %>% 
  select(c(1:2000))

patient_6 <- read_rds(file = "Data/_raw/GSM4058977_177I.dgecounts.rds")

Genes <- patient_6 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>%   
  pluck("Dimnames") %>% 
  pluck(1) %>% 
  as_tibble()

write_csv(Genes,
          file = "Data/Genes_6")
rm(Genes)

patient_6 <- patient_6 %>% 
  pluck("umicount") %>% 
  pluck("exon") %>% 
  pluck("all") %>% 
  as_tibble() %>% 
  select(c(1:2000))

```

After all operations have been carried out we write all the data to seperate files
```{r writing}
# Patient_1
write.csv(patient_1,
          file = "Data/01_patient_1I.csv.gz")

# Patient_2
write.csv(patient_2,
          file = "Data/01_patient_2C.csv.gz")

# Patient_3
write.csv(patient_3,
          file = "Data/01_patient_3C.csv.gz")

# Patient_4
write.csv(patient_4,
          file = "Data/01_patient_4CO.csv.gz")

# Patient_5
write.csv(patient_5,
          file = "Data/01_patient_5CO.csv.gz")

# Patient_6
write.csv(patient_6,
          file = "Data/01_patient_6I.csv.gz")
```


Cleaning the data:
Load data --------------------------------------------------------------------

```{r}
# Patient 1
patient_1 <- read_csv(file = "Data/01_patient_1I.csv.gz")

# Patient_2
patient_2 <- read_csv(file = "Data/01_patient_2C.csv.gz")

# Patient_3
patient_3 <- read_csv(file = "Data/01_patient_3C.csv.gz")

# Patient_4
patient_4 <- read_csv(file = "Data/01_patient_4CO.csv.gz")

# Patient_5
patient_5 <- read_csv(file = "Data/01_patient_5CO.csv.gz")

# Patient_6
patient_6 <- read_csv(file = "Data/01_patient_6I.csv.gz")

```


Combining patients -----------------------------------------------------------

Wrangle data -----------------------------------------------------------------

 ------------------- Getting gene names and cell bar codes -------------------

Loading metadata and getting cell types --------------------------------------
Metadata supplied by the authors of the paper("ids.csv")

```{r}
gene_mapping <- read_csv("Data/_raw/ids.csv",
                         col_names=c("value","Gene")) %>%
  tibble()

```

Transpose so that genes are columns and rows are cells

```{r}
patient_1 <- patient_1 %>% 
  rownames_to_column() %>%  
  pivot_longer(-rowname) %>% 
  pivot_wider(names_from = rowname,
              values_from = value)

Genes <- read_csv("Data/Genes_1")
Genes <- Genes %>%
  left_join(gene_mapping) %>%
  pluck("Gene")

```


Rename genes and make nice name for column with barcodes

```{r}
colnames(patient_1) <- c("Cell_Barcode",
                         Genes)

```


-------------- now do the same for 5 other patients --------------


```{r}
# Patient_2
patient_2 <- patient_2 %>%
  rownames_to_column() %>%  
  pivot_longer(-rowname) %>% 
  pivot_wider(names_from = rowname,
              values_from = value)

Genes <- read_csv("Data/Genes_2")
Genes <- Genes %>% 
  left_join(gene_mapping) %>% 
  pluck("Gene")

colnames(patient_2) <- c("Cell_Barcode",
                         Genes)
# Patient_3
patient_3 <- patient_3 %>% 
  rownames_to_column() %>%  
  pivot_longer(-rowname) %>% 
  pivot_wider(names_from = rowname,
              values_from = value)

Genes <- read_csv("Data/Genes_3")
Genes <-Genes %>% 
  left_join(gene_mapping) %>% 
  pluck("Gene")

colnames(patient_3) <- c("Cell_Barcode",
                         Genes)

#Patient_4               
patient_4 <- patient_4 %>% 
  rownames_to_column() %>%  
  pivot_longer(-rowname) %>% 
  pivot_wider(names_from = rowname,
              values_from = value)

Genes <- read_csv("Data/Genes_4")
Genes <- Genes %>% 
  left_join(gene_mapping) %>% 
  pluck("Gene")

colnames(patient_4) <- c("Cell_Barcode",
                         Genes)

#Patient_5               
patient_5 <- patient_5 %>% 
  rownames_to_column() %>%  
  pivot_longer(-rowname) %>% 
  pivot_wider(names_from = rowname,
              values_from = value)

Genes <- read_csv("Data/Genes_5")
Genes <- Genes %>% 
  left_join(gene_mapping) %>% 
  pluck("Gene")

colnames(patient_5) <- c("Cell_Barcode",
                         Genes)

#Patient_6                
patient_6 <- patient_6 %>% 
  rownames_to_column() %>%  
  pivot_longer(-rowname) %>% 
  pivot_wider(names_from = rowname, 
              values_from = value)

Genes <- read_csv("Data/Genes_6")
Genes <- Genes %>% 
  left_join(gene_mapping) %>% 
  pluck("Gene")

colnames(patient_6) <- c("Cell_Barcode",
                         Genes)

```




 Write data -------------------------------------------------------------------
 
 
```{r}
# Patient_1
write.csv(patient_1,
          file = "Data/02_patient_1I.csv.gz")

# Patient_2
write.csv(patient_2,
          file = "Data/02_patient_2C.csv.gz")

# Patient_3
write.csv(patient_3,
          file = "Data/02_patient_3C.csv.gz")

# Patient_4
write.csv(patient_4,
          file = "Data/02_patient_4CO.csv.gz")

# Patient_5
write.csv(patient_5,
          file = "Data/02_patient_5CO.csv.gz")

# Patient_6
write.csv(patient_6,
          file = "Data/02_patient_6I.csv.gz")
```
 
 


Remove Data ------------------------------------------------------------------

```{r}
rm(patient_1,
   patient_2,
   patient_3,
   patient_4,
   patient_5,
   patient_6,
   Genes,
   gene_mapping)

```



Augmenting the data:
Load data --------------------------------------------------------------------

```{r}
# Patient_1
patient_1 <- read_csv(file = "Data/02_patient_1I.csv.gz")

patient_1 <- patient_1 %>% 
  mutate(Patient_ID = "025I",
         .before = Cell_Barcode) %>% 
  select(Patient_ID:ncol(patient_1)) %>% 
  filter(Cell_Barcode != "X1")

# Patient_2                ---------------------------
patient_2 <- read_csv(file = "Data/02_patient_2C.csv.gz")

patient_2 <- patient_2 %>% 
  mutate(Patient_ID = "465C",
         .before = Cell_Barcode) %>% 
  select(Patient_ID:ncol(patient_2)) %>% 
  filter(Cell_Barcode != "X1")

# Patient_3                ---------------------------
patient_3 <- read_csv(file = "Data/02_patient_3C.csv.gz")

patient_3 <- patient_3 %>% 
  mutate(Patient_ID = "003C",
         .before = Cell_Barcode) %>% 
  select(Patient_ID:ncol(patient_3)) %>% 
  filter(Cell_Barcode != "X1")

# Patient_4                ---------------------------
patient_4 <- read_csv(file = "Data/02_patient_4CO.csv.gz")

patient_4 <- patient_4 %>% 
  mutate(Patient_ID = "207CO",
         .before = Cell_Barcode) %>% 
  select(Patient_ID:ncol(patient_4)) %>% 
  filter(Cell_Barcode != "X1")

# Patient_5                ---------------------------
patient_5 <- read_csv(file = "Data/02_patient_5CO.csv.gz")

patient_5 <- patient_5 %>% 
  mutate(Patient_ID = "056CO",
         .before = Cell_Barcode)%>% 
  select(Patient_ID:ncol(patient_5)) %>% 
  filter(Cell_Barcode != "X1")

# Patient_6                ---------------------------
patient_6 <- read_csv(file = "Data/02_patient_6I.csv.gz")

patient_6 <- patient_6 %>% 
  mutate(Patient_ID = "177I",
         .before = Cell_Barcode) %>% 
  select(Patient_ID:ncol(patient_6)) %>% 
  filter(Cell_Barcode != "X1")

```


Combining patients------------------------------------------------------------


```{r}
data <- bind_rows(
  patient_1,
  patient_2,
  patient_3,
  patient_4,
  patient_5,
  patient_6)
```

Replacing NAs (gene not present in the patient but in another) by 0

```{r}
data <- data %>%
  mutate(across(everything(),
           ~replace_na(.x,
                       0))) %>% 
  select(-starts_with("ENSG"))

```


Clearing environment

```{r}
rm(patient_1, 
   patient_2,
   patient_3,
   patient_4,
   patient_5,
   patient_6)
```


Loading metadata -------------------------------------------------------------

```{r}
metadata <- read_tsv(
  "Data/_raw/GSE136831_AllCells.Samples.CellType.MetadataTable.txt") %>% 
  tibble() %>% 
  select(CellBarcode_Identity,
         nUMI,
         nGene,
         CellType_Category,
         Subclass_Cell_Identity,
         Subject_Identity) %>% 
  rename(Patient_ID = Subject_Identity,
         Cell_Barcode = CellBarcode_Identity) %>% 
  filter(Patient_ID == "025I" |
           Patient_ID == "465C" |
           Patient_ID == "003C" |
           Patient_ID == "207CO"|
           Patient_ID == "056CO"|
           Patient_ID == "177I") %>% 
  mutate(Cell_Barcode = str_replace_all(Cell_Barcode,
                                        "(.+_)(.+)",
                                        "\\2"))
```


Join metadata and patient data------------------------------------------------

```{r}
data <- left_join(data,
                  metadata,
                  by = c("Patient_ID",
                         "Cell_Barcode")) %>% 
  relocate("nGene",
           "nUMI",
           "CellType_Category",
           "Subclass_Cell_Identity",
           .after = "Cell_Barcode") 
```


Introduce group label and make that and Patient_ID factors


```{r}
data <-
  data %>% 
  mutate(group = 
           factor(
             case_when(
             str_detect(Patient_ID,"I") ~ "IPF",
             str_detect(Patient_ID,"CO") ~ "COPD",
             TRUE ~ "Control")),         
         .after = Patient_ID,
         Patient_ID = factor(Patient_ID))

rm(metadata)

```



Now there are quite some NAs as the metadata apparently contains only cells 
filtered by the authors.
We will filter further to second-check this filtering. Thus if it works well, 
the NAs will mostly be gone

Wrangle data -----------------------------------------------------------------

Combine the patients' gene expression to the metadata data of the cells.
Run patient_slicer, meta_slicer, combiner and binder

If there are cells with fewer than 2000 transcripts recorded, these cells are
filtered out from the 10000 starting cell count per patient

```{r}
data <- data %>% 
  filter(nUMI > 2000)
```


Filtering out the cells where the transcripts of the mitochondrial genes 
represent more than 20% of the sum of the transcripts for a cell
```{r}
mt_selection <- select(data, 
                       starts_with("MT"))

mt_sum <- mt_selection %>% 
  mutate(mito_sum = rowSums(mt_selection))

data <- data %>%
  mutate(select(mt_sum,
                mito_sum),
         .after = Cell_Barcode) %>%
  filter(mito_sum / nUMI < 0.2)
```


Now check if there are any NAs remaining

```{r}
data %>% 
  filter(
  across(.cols = everything(),
         .fns = ~ is.na(.x)))

```



Write data -------------------------------------------------------------------

```{r}
write_csv(data, 
          file = "Data/03_data.csv")
```


Remove Data ------------------------------------------------------------------

```{r}
rm(data,
   mt_selection,
   mt_sum)
```







